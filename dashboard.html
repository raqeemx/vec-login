<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام تقييم المركبات المستردة</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Inline Styles (من الملف الأصلي) -->
    <style>
        /* نفس الـ CSS من dashboard.html الأصلي بدون تغيير */
        /* أضف كل الـ CSS هنا - تم تركه للاختصار */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
            background: #f1f5f9;
            transition: all 0.3s ease;
        }
        
        /* باقي الـ CSS... - يمكنك نسخه من dashboard.html الأصلي */
    </style>
</head>
<body>
    <!-- Loading Screen على كامل الصفحة -->
    <div id="authCheckLoader" style="position: fixed; inset: 0; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; z-index: 99999;">
        <div style="text-align: center; color: white;">
            <div style="width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <h3 style="font-size: 1.2rem;">جاري التحقق من الحساب...</h3>
        </div>
    </div>

    <!-- باقي محتوى dashboard.html الأصلي بالكامل -->
    <!-- يتم إخفاؤه حتى يتم التحقق من المصادقة -->
    <div id="mainContent" style="display: none;">
        <!-- نسخ كل محتوى dashboard.html هنا -->
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        // ========================================
        // ⚠️ CRITICAL: Firebase Configuration
        // ⚠️ استبدل هذه القيم بإعدادات Firebase الخاصة بك
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA7B27LIH9FPZAsMKr5lvm2AIa3ZkZNOUo",
            authDomain: "vec-login-58dea.firebaseapp.com",
            projectId: "vec-login-58dea",
            storageBucket: "vec-login-58dea.firebasestorage.app",
            messagingSenderId: "651347381212",
            appId: "1:651347381212:web:dc7eba2bbf69532e13dd19"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========================================
        // ⚠️ PROTECTION: Authentication Check
        // هذا الكود يحمي الصفحة من الوصول غير المصرح
        // ========================================
        let isAuthenticated = false;
        let currentUser = null;

        auth.onAuthStateChanged(async (user) => {
            const authCheckLoader = document.getElementById('authCheckLoader');
            const mainContent = document.getElementById('mainContent');
            
            if (user) {
                // المستخدم مسجل الدخول
                isAuthenticated = true;
                currentUser = user;
                
                // إخفاء loader وإظهار المحتوى
                authCheckLoader.style.display = 'none';
                mainContent.style.display = 'block';
                
                // تحميل بيانات المستخدم والمركبات
                updateUserUI(user);
                setupRealtimeSync();
                loadVehicles();
            } else {
                // المستخدم غير مسجل - إعادة توجيه لصفحة الدخول
                window.location.href = 'index.html';
            }
        });

        // ========================================
        // باقي كود JavaScript من dashboard.html
        // ========================================
        let vehicles = [];
        let filteredVehicles = [];
        let deleteVehicleId = null;
        let unsubscribeSnapshot = null;

        function updateUserUI(user) {
            const displayName = user.displayName || 'المستخدم';
            const email = user.email || '';
            const initials = getInitials(displayName);
            
            // Update sidebar
            const sidebarUserName = document.getElementById('sidebarUserName');
            const sidebarUserEmail = document.getElementById('sidebarUserEmail');
            const sidebarInitials = document.getElementById('sidebarInitials');
            
            if (sidebarUserName) sidebarUserName.textContent = displayName;
            if (sidebarUserEmail) sidebarUserEmail.textContent = email;
            if (sidebarInitials) sidebarInitials.textContent = initials;
            
            // Update top bar
            const profileName = document.getElementById('profileName');
            const profileInitials = document.getElementById('profileInitials');
            
            if (profileName) profileName.textContent = displayName.split(' ')[0];
            if (profileInitials) profileInitials.textContent = initials;
            
            // Update avatar if photo exists
            if (user.photoURL) {
                const sidebarAvatar = document.getElementById('sidebarAvatar');
                const profileAvatar = document.getElementById('profileAvatar');
                if (sidebarAvatar) sidebarAvatar.innerHTML = `<img src="${user.photoURL}" alt="">`;
                if (profileAvatar) profileAvatar.innerHTML = `<img src="${user.photoURL}" alt="">`;
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function setupRealtimeSync() {
            if (!currentUser) return;
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            
            unsubscribeSnapshot = db.collection('users')
                .doc(currentUser.uid)
                .collection('vehicles')
                .orderBy('createdAt', 'desc')
                .onSnapshot(
                    (snapshot) => {
                        vehicles = [];
                        snapshot.forEach(doc => {
                            vehicles.push({ id: doc.id, ...doc.data() });
                        });
                        filteredVehicles = [...vehicles];
                        renderVehicles();
                        updateStats();
                        updateSyncStatus('connected');
                    },
                    (error) => {
                        console.error('Sync Error:', error);
                        updateSyncStatus('offline');
                        showNotification('خطأ في المزامنة', 'error');
                    }
                );
        }

        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (!syncStatus || !syncText) return;
            
            syncStatus.className = 'sync-status';
            
            if (status === 'connected') {
                syncText.textContent = 'متصل';
            } else if (status === 'syncing') {
                syncStatus.classList.add('syncing');
                syncText.textContent = 'جاري المزامنة...';
            } else {
                syncStatus.classList.add('offline');
                syncText.textContent = 'غير متصل';
            }
        }

        async function loadVehicles() {
            showLoading('جاري تحميل البيانات...');
            
            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('vehicles')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                vehicles = [];
                snapshot.forEach(doc => {
                    vehicles.push({ id: doc.id, ...doc.data() });
                });
                
                filteredVehicles = [...vehicles];
                renderVehicles();
                updateStats();
                hideLoading();
                
            } catch (error) {
                console.error('Load Error:', error);
                hideLoading();
                showNotification('خطأ في تحميل البيانات', 'error');
            }
        }

        function renderVehicles() {
            const grid = document.getElementById('vehiclesGrid');
            const vehicleCount = document.getElementById('vehicleCount');
            
            if (!grid) return;
            if (vehicleCount) vehicleCount.textContent = vehicles.length;
            
            if (filteredVehicles.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-car"></i>
                        <h3>لا توجد مركبات</h3>
                        <p>ابدأ بإضافة مركبة جديدة للبدء</p>
                        <button class="btn btn-primary" onclick="openAddModal()">
                            <i class="fas fa-plus"></i>
                            إضافة مركبة
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredVehicles.map(v => `
                <div class="vehicle-card">
                    <div class="vehicle-header">
                        <div>
                            <div class="vehicle-title">${v.make || ''} ${v.model || ''} ${v.year || ''}</div>
                            <div class="vehicle-id">${v.contractNo || 'بدون رقم عقد'}</div>
                        </div>
                        <span class="vehicle-status status-${v.overallRating || 'good'}">${getRatingText(v.overallRating)}</span>
                    </div>
                    
                    <div class="vehicle-details">
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>${v.customerName || 'غير محدد'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-barcode"></i>
                            <span>${v.vin || 'غير محدد'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>${v.odometer ? v.odometer.toLocaleString() + ' كم' : 'غير محدد'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-id-card"></i>
                            <span>${v.plateNo || 'غير محدد'}</span>
                        </div>
                    </div>
                    
                    <div class="vehicle-value">
                        <span>القيمة السوقية</span>
                        <strong>${v.marketValue ? v.marketValue.toLocaleString() : 0} ريال</strong>
                    </div>
                    
                    <div class="vehicle-actions">
                        <button class="btn-view" onclick="viewVehicle('${v.id}')">
                            <i class="fas fa-eye"></i>
                            عرض
                        </button>
                        <button class="btn-edit" onclick="editVehicle('${v.id}')">
                            <i class="fas fa-edit"></i>
                            تعديل
                        </button>
                        <button class="btn-delete" onclick="deleteVehicle('${v.id}')">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getRatingText(rating) {
            const ratings = {
                'excellent': 'ممتاز',
                'good': 'جيد',
                'fair': 'مقبول',
                'poor': 'ضعيف'
            };
            return ratings[rating] || 'غير محدد';
        }

        function updateStats() {
            const total = vehicles.length;
            const totalValue = vehicles.reduce((sum, v) => sum + (parseFloat(v.marketValue) || 0), 0);
            
            const ratingValues = { excellent: 4, good: 3, fair: 2, poor: 1 };
            const ratedVehicles = vehicles.filter(v => v.overallRating);
            const avgRating = ratedVehicles.length > 0
                ? ratedVehicles.reduce((sum, v) => sum + (ratingValues[v.overallRating] || 0), 0) / ratedVehicles.length
                : 0;
            
            const now = new Date();
            const thisMonth = vehicles.filter(v => {
                if (!v.createdAt) return false;
                const date = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            
            const statTotal = document.getElementById('statTotalVehicles');
            const statValue = document.getElementById('statTotalValue');
            const statRating = document.getElementById('statAvgRating');
            const statMonth = document.getElementById('statThisMonth');
            
            if (statTotal) statTotal.textContent = total;
            if (statValue) statValue.textContent = totalValue.toLocaleString();
            if (statRating) statRating.textContent = avgRating > 0 ? avgRating.toFixed(1) : '-';
            if (statMonth) statMonth.textContent = thisMonth;
        }

        // باقي الدوال (saveVehicle, deleteVehicle, exportToExcel, etc.)
        // انسخها من dashboard.html الأصلي

        async function handleLogout() {
            showLoading('جاري تسجيل الخروج...');
            try {
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout Error:', error);
                hideLoading();
                showNotification('خطأ في تسجيل الخروج', 'error');
            }
        }

        function showLoading(text = 'جاري التحميل...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (overlay) overlay.classList.add('show');
            if (loadingText) loadingText.textContent = text;
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('show');
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50px)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Dark Mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            const darkModeIcon = document.getElementById('darkModeIcon');
            if (darkModeIcon) darkModeIcon.className = 'fas fa-sun';
        }
    </script>
</body>
</html>